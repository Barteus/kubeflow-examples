# Kubecon EU 2022

Instruction how to recreate the environment. Valid

## Use Azure storage

Create Azure storage and save the Access Credentials in secret folder

```
/kubecon-eu-2022
├── datacenter
├── edge
├── README.md
└── secret
    ├── minio-sa-key1
    └── minio-sa-name
```

Example:

```
echo -n "sa-name" > ./secret/minio-sa-name
echo -n "sa-key1" > ./secret/minio-sa-key1
```

**Do not** add new line character at the end of file!!!

## Datacenter

Minimum of 4 CPU and 16GB RAM is required

### Install k8s, juju, kubectl

Check data-drift -> Tools setup section

### Install CKF

Documentation: https://charmed-kubeflow.io/docs/install

Deploy

```
juju deploy ./datacenter/bundle.yaml --trust
```

Post deployment actions

```
kubectl patch role -n kubeflow istio-ingressgateway-operator -p '{"apiVersion":"rbac.authorization.k8s.io/v1","kind":"Role","metadata":{"name":"istio-ingressgateway-operator"},"rules":[{"apiGroups":["*"],"resources":["*"],"verbs":["*"]}]}'

juju config dex-auth static-username=admin
juju config dex-auth static-password=admin123
juju config dex-auth public-url=http://10.64.140.44.nip.io/
juju config oidc-gatekeeper public-url=http://10.64.140.44.nip.io/
```

Fix admin user namespace issues and apply the yamls

```
kubectl apply -f ./datacenter/minio-jupyter-config.yaml -n admin
kubectl apply -f ./datacenter/mlflow-jupyter-config.yaml -n admin
```

### Run demo

Create the notebook instance and clone the repository there. Use
the `e2e-wine-kfp-mlflow` example and execute the notebook there. Result should
be deployed model. From Deploy task take the yaml and copy it. You
will need it to deploy it on the edge cloud.

Endpoint is deployed in datacenter - this endpoint can be used a fallback in
case the edge device could not handle the load.

## Edge

Minimum of 4 CPU and 8GB RAM is required (works on RaspberryPi)

### Install k8s, juju, kubectl

Check data-drift -> Tools setup section

### Install knative

Check data-drift -> Install Knative section

### Deploy bundle

Bundle contains only required parts of CKF tailed to the use-case

```
juju deploy ./edge/bundle.yaml --trust
```

### Deploy the model

Adjust the wine-super-model by changing the modelUri to the one generated by the
pipeline run. The proper value can be taken from the "Deploy" step in pipeline
ran.

```
kubectl apply -f ./edge/wine-deployment.yaml -n kubeflow
```